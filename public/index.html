<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Claude Think Tracker</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: #0f0f0f;
        color: #e0e0e0;
        line-height: 1.6;
      }
      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 0;
        border-bottom: 1px solid #333;
        margin-bottom: 20px;
      }
      h1 {
        color: #f0f0f0;
        font-size: 1.8rem;
      }
      .nav {
        display: flex;
        gap: 10px;
      }
      .nav button {
        background: #1a1a1a;
        border: 1px solid #333;
        color: #e0e0e0;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
      }
      .nav button:hover,
      .nav button.active {
        background: #2a2a2a;
        border-color: #4a9eff;
      }
      .search-bar {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }
      .search-bar input {
        flex: 1;
        background: #1a1a1a;
        border: 1px solid #333;
        color: #e0e0e0;
        padding: 12px 16px;
        border-radius: 6px;
        font-size: 1rem;
      }
      .search-bar input:focus {
        outline: none;
        border-color: #4a9eff;
      }
      .search-bar button {
        background: #4a9eff;
        border: none;
        color: #fff;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
      }
      .search-bar button:hover {
        background: #3a8eef;
      }
      .panel {
        display: none;
      }
      .panel.active {
        display: block;
      }
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      .stat-card {
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 20px;
      }
      .stat-card h3 {
        color: #888;
        font-size: 0.85rem;
        text-transform: uppercase;
        margin-bottom: 8px;
      }
      .stat-card .value {
        font-size: 2rem;
        font-weight: 600;
        color: #4a9eff;
      }
      .session-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .session-card {
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 16px 20px;
        cursor: pointer;
        transition: all 0.2s;
      }
      .session-card:hover {
        border-color: #4a9eff;
        background: #1f1f1f;
      }
      .session-card h3 {
        color: #f0f0f0;
        margin-bottom: 8px;
      }
      .session-card .meta {
        color: #888;
        font-size: 0.9rem;
      }
      .session-card .meta span {
        margin-right: 16px;
      }
      .message-list {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      .message-card {
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 16px;
      }
      .message-card.user {
        border-left: 3px solid #4a9eff;
      }
      .message-card.assistant {
        border-left: 3px solid #22c55e;
      }
      .message-card.system {
        border-left: 3px solid #f59e0b;
      }
      .message-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 1px solid #2a2a2a;
      }
      .message-role {
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.8rem;
      }
      .message-card.user .message-role {
        color: #4a9eff;
      }
      .message-card.assistant .message-role {
        color: #22c55e;
      }
      .message-card.system .message-role {
        color: #f59e0b;
      }
      .message-content {
        white-space: pre-wrap;
        margin-bottom: 12px;
      }
      .thinking-block {
        background: #0a0a0a;
        border: 1px solid #333;
        border-radius: 6px;
        padding: 12px;
        margin-top: 12px;
      }
      .thinking-block h4 {
        color: #a855f7;
        font-size: 0.85rem;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .thinking-block pre {
        white-space: pre-wrap;
        color: #c0c0c0;
        font-size: 0.9rem;
        max-height: 300px;
        overflow-y: auto;
      }
      .tool-calls {
        margin-top: 12px;
      }
      .tool-call {
        background: #0a0a0a;
        border: 1px solid #333;
        border-radius: 6px;
        padding: 10px;
        margin-top: 8px;
      }
      .tool-call h5 {
        color: #f59e0b;
        font-size: 0.85rem;
        margin-bottom: 6px;
      }
      .tool-call pre {
        font-size: 0.8rem;
        color: #888;
        overflow-x: auto;
      }
      .tokens {
        color: #666;
        font-size: 0.8rem;
      }
      .back-btn {
        background: #1a1a1a;
        border: 1px solid #333;
        color: #e0e0e0;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        margin-bottom: 20px;
      }
      .back-btn:hover {
        background: #2a2a2a;
      }
      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #666;
      }
      .search-results .result-item {
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
      }
      .search-results .highlight {
        background: #4a9eff33;
        padding: 2px 4px;
        border-radius: 3px;
      }
      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>üß† Claude Think Tracker</h1>
        <nav class="nav">
          <button id="nav-dashboard" class="active">Dashboard</button>
          <button id="nav-sessions">Sessions</button>
          <button id="nav-search">Search</button>
        </nav>
      </header>

      <!-- Dashboard Panel -->
      <div id="panel-dashboard" class="panel active">
        <div class="stats-grid" id="stats-grid"></div>
        <h2 style="margin-bottom: 16px; color: #f0f0f0">Recent Sessions</h2>
        <div class="session-list" id="recent-sessions"></div>
      </div>

      <!-- Sessions Panel -->
      <div id="panel-sessions" class="panel">
        <div class="session-list" id="all-sessions"></div>
      </div>

      <!-- Session Detail Panel -->
      <div id="panel-session-detail" class="panel">
        <button class="back-btn" id="back-to-sessions">‚Üê Back to Sessions</button>
        <div id="session-info"></div>
        <h2 style="margin: 20px 0 16px; color: #f0f0f0">Messages</h2>
        <div class="message-list" id="session-messages"></div>
      </div>

      <!-- Search Panel -->
      <div id="panel-search" class="panel">
        <div class="search-bar">
          <input
            type="text"
            id="search-input"
            placeholder="Search messages and thinking content..."
          />
          <button id="search-btn">Search</button>
        </div>
        <div class="search-results" id="search-results">
          <div class="empty-state">Enter a search query to find messages</div>
        </div>
      </div>
    </div>

    <script>
      const API = '/api'
      let currentPanel = 'dashboard'

      // Navigation
      document.querySelectorAll('.nav button').forEach((btn) => {
        btn.addEventListener('click', () => {
          const panel = btn.id.replace('nav-', '')
          showPanel(panel)
        })
      })

      function showPanel(panel) {
        document.querySelectorAll('.panel').forEach((p) => p.classList.remove('active'))
        document
          .querySelectorAll('.nav button')
          .forEach((b) => b.classList.remove('active'))
        document.getElementById(`panel-${panel}`).classList.add('active')
        const navBtn = document.getElementById(`nav-${panel}`)
        if (navBtn) navBtn.classList.add('active')
        currentPanel = panel

        if (panel === 'dashboard') loadDashboard()
        if (panel === 'sessions') loadSessions()
      }

      // Dashboard
      async function loadDashboard() {
        try {
          const [stats, sessions] = await Promise.all([
            fetch(`${API}/analytics/overview`).then((r) => r.json()),
            fetch(`${API}/sessions?limit=5`).then((r) => r.json())
          ])

          document.getElementById('stats-grid').innerHTML = `
          <div class="stat-card">
            <h3>Total Sessions</h3>
            <div class="value">${stats.total_sessions || 0}</div>
          </div>
          <div class="stat-card">
            <h3>Total Messages</h3>
            <div class="value">${stats.total_messages || 0}</div>
          </div>
          <div class="stat-card">
            <h3>Thinking Tokens</h3>
            <div class="value">${formatNumber(stats.total_thinking_tokens || 0)}</div>
          </div>
          <div class="stat-card">
            <h3>Total Tokens</h3>
            <div class="value">${formatNumber(
              (stats.total_input_tokens || 0) + (stats.total_output_tokens || 0)
            )}</div>
          </div>
        `

          renderSessionList('recent-sessions', sessions.sessions || [])
        } catch (err) {
          console.error('Failed to load dashboard:', err)
        }
      }

      // Sessions
      async function loadSessions() {
        try {
          const data = await fetch(`${API}/sessions`).then((r) => r.json())
          renderSessionList('all-sessions', data.sessions || [])
        } catch (err) {
          console.error('Failed to load sessions:', err)
        }
      }

      function renderSessionList(containerId, sessions) {
        const container = document.getElementById(containerId)
        if (!sessions || sessions.length === 0) {
          container.innerHTML = '<div class="empty-state">No sessions found</div>'
          return
        }
        container.innerHTML = sessions
          .map(
            (s) => `
        <div class="session-card" onclick="loadSessionDetail('${s.id}')">
          <h3>${escapeHtml(s.name || 'Unnamed Session')}</h3>
          <div class="meta">
            <span>üìÖ ${new Date(s.started_at).toLocaleString()}</span>
            <span>üí¨ ${s.message_count || 0} messages</span>
            ${s.project_path ? `<span>üìÅ ${escapeHtml(s.project_path)}</span>` : ''}
          </div>
        </div>
      `
          )
          .join('')
      }

      async function loadSessionDetail(id) {
        try {
          const [session, messages] = await Promise.all([
            fetch(`${API}/sessions/${id}`).then((r) => r.json()),
            fetch(`${API}/sessions/${id}/messages`).then((r) => r.json())
          ])

          document.getElementById('session-info').innerHTML = `
          <h2 style="color: #f0f0f0; margin-bottom: 8px;">${escapeHtml(
            session.name || 'Unnamed Session'
          )}</h2>
          <div class="meta" style="color: #888;">
            Started: ${new Date(session.started_at).toLocaleString()}
            ${
              session.ended_at
                ? ` | Ended: ${new Date(session.ended_at).toLocaleString()}`
                : ' | Active'
            }
          </div>
        `

          renderMessages('session-messages', messages.messages || [])
          showPanel('session-detail')
        } catch (err) {
          console.error('Failed to load session:', err)
        }
      }

      document
        .getElementById('back-to-sessions')
        .addEventListener('click', () => showPanel('sessions'))

      function renderMessages(containerId, messages) {
        const container = document.getElementById(containerId)
        if (!messages || messages.length === 0) {
          container.innerHTML =
            '<div class="empty-state">No messages in this session</div>'
          return
        }
        container.innerHTML = messages
          .map(
            (m) => `
        <div class="message-card ${m.role}">
          <div class="message-header">
            <span class="message-role">${m.role}</span>
            <span class="tokens">
              ${m.input_tokens ? `In: ${m.input_tokens}` : ''}
              ${m.output_tokens ? ` | Out: ${m.output_tokens}` : ''}
              ${m.thinking_tokens ? ` | Think: ${m.thinking_tokens}` : ''}
            </span>
          </div>
          <div class="message-content">${escapeHtml(truncate(m.content, 1000))}</div>
          ${
            m.thinking_content
              ? `
            <div class="thinking-block">
              <h4>üß† Extended Thinking</h4>
              <pre>${escapeHtml(m.thinking_content)}</pre>
            </div>
          `
              : ''
          }
          ${
            m.tool_calls && m.tool_calls.length
              ? `
            <div class="tool-calls">
              <h4 style="color: #f59e0b; font-size: 0.85rem;">üîß Tool Calls</h4>
              ${m.tool_calls
                .map(
                  (tc) => `
                <div class="tool-call">
                  <h5>${escapeHtml(tc.name)}</h5>
                  <pre>${escapeHtml(JSON.stringify(tc.input, null, 2))}</pre>
                </div>
              `
                )
                .join('')}
            </div>
          `
              : ''
          }
        </div>
      `
          )
          .join('')
      }

      // Search
      document.getElementById('search-btn').addEventListener('click', doSearch)
      document.getElementById('search-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') doSearch()
      })

      async function doSearch() {
        const query = document.getElementById('search-input').value.trim()
        if (query.length < 2) return

        const container = document.getElementById('search-results')
        container.innerHTML = '<div class="loading">Searching...</div>'

        try {
          const data = await fetch(
            `${API}/search?q=${encodeURIComponent(query)}`
          ).then((r) => r.json())
          const results = data.results || []
          if (results.length === 0) {
            container.innerHTML = '<div class="empty-state">No results found</div>'
            return
          }
          container.innerHTML = results
            .map(
              (r) => `
          <div class="result-item">
            <div style="margin-bottom: 8px;">
              <span class="message-role" style="color: ${
                r.role === 'user' ? '#4a9eff' : '#22c55e'
              }">${r.role}</span>
              <span style="color: #666; margin-left: 12px;">${new Date(
                r.created_at
              ).toLocaleString()}</span>
            </div>
            <div>${r.content_snippet || escapeHtml(r.content) || ''}</div>
            ${
              r.thinking_snippet || r.thinking_content
                ? `
              <div class="thinking-block" style="margin-top: 8px;">
                <h4>üß† Thinking Match</h4>
                <pre>${r.thinking_snippet || escapeHtml(r.thinking_content) || ''}</pre>
              </div>
            `
                : ''
            }
          </div>
        `
            )
            .join('')
        } catch (err) {
          container.innerHTML = '<div class="empty-state">Search failed</div>'
          console.error('Search error:', err)
        }
      }

      // Utilities
      function escapeHtml(str) {
        if (!str) return ''
        return str
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
      }

      function truncate(str, len) {
        if (!str || str.length <= len) return str
        return str.substring(0, len) + '...'
      }

      function formatNumber(n) {
        if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M'
        if (n >= 1000) return (n / 1000).toFixed(1) + 'K'
        return n.toString()
      }

      function highlightMatch(text, query) {
        if (!text) return ''
        const escaped = escapeHtml(truncate(text, 500))
        const regex = new RegExp(
          `(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`,
          'gi'
        )
        return escaped.replace(regex, '<span class="highlight">$1</span>')
      }

      // Initial load
      loadDashboard()
    </script>
  </body>
</html>
